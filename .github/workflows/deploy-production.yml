name: Build and Deploy Production

on:
  push:
    branches: [ production, main ]
    tags:
      - 'v*'
  workflow_dispatch:

env:
  FLUTTER_VERSION: '3.35.4'
  JAVA_VERSION: '17'

jobs:
  # ========================================
  # Test Job - Run tests before building
  # ========================================
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Java
      uses: actions/setup-java@v4
      with:
        distribution: 'zulu'
        java-version: ${{ env.JAVA_VERSION }}
    
    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: ${{ env.FLUTTER_VERSION }}
        channel: 'stable'
        cache: true
    
    - name: Install dependencies
      run: flutter pub get
    
    - name: Run analyzer
      run: flutter analyze --no-fatal-infos

    - name: Clean build cache
      run: flutter clean

    - name: Run tests
      run: flutter test
    
    - name: Upload test results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: test-results
        path: test-results/
  
  # ========================================
  # Build APK Job - Production release
  # ========================================
  build-apk:
    name: Build Production APK
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/production' || startsWith(github.ref, 'refs/tags/v')
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Java
      uses: actions/setup-java@v4
      with:
        distribution: 'zulu'
        java-version: ${{ env.JAVA_VERSION }}
    
    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: ${{ env.FLUTTER_VERSION }}
        channel: 'stable'
        cache: true
    
    - name: Install dependencies
      run: flutter pub get
    
    - name: Decode Android keystore
      run: |
        echo "${{ secrets.ANDROID_KEYSTORE }}" | base64 -d > android/release-key.jks
        echo "storePassword=${{ secrets.ANDROID_STORE_PASSWORD }}" > android/key.properties
        echo "keyPassword=${{ secrets.ANDROID_KEY_PASSWORD }}" >> android/key.properties
        echo "keyAlias=release" >> android/key.properties
        echo "storeFile=../release-key.jks" >> android/key.properties
    
    - name: Decode google-services.json
      run: |
        echo "${{ secrets.GOOGLE_SERVICES_JSON }}" | base64 -d > android/app/google-services.json
    
    - name: Build APK (Universal)
      run: |
        flutter build apk --release \
          --dart-define=PRODUCTION=true \
          --dart-define=PAWAPAY_API_TOKEN=${{ secrets.PAWAPAY_API_TOKEN }} \
          --dart-define=PAWAPAY_DEPOSIT_CALLBACK=${{ secrets.PAWAPAY_DEPOSIT_CALLBACK }} \
          --dart-define=PAWAPAY_WITHDRAWAL_CALLBACK=${{ secrets.PAWAPAY_WITHDRAWAL_CALLBACK }} \
          --dart-define=API_BASE_URL=${{ secrets.API_BASE_URL }}
    
    - name: Build APK (Split per ABI)
      run: |
        flutter build apk --release --split-per-abi \
          --dart-define=PRODUCTION=true \
          --dart-define=PAWAPAY_API_TOKEN=${{ secrets.PAWAPAY_API_TOKEN }} \
          --dart-define=PAWAPAY_DEPOSIT_CALLBACK=${{ secrets.PAWAPAY_DEPOSIT_CALLBACK }} \
          --dart-define=PAWAPAY_WITHDRAWAL_CALLBACK=${{ secrets.PAWAPAY_WITHDRAWAL_CALLBACK }} \
          --dart-define=API_BASE_URL=${{ secrets.API_BASE_URL }}
    
    - name: Get version from pubspec
      id: version
      run: |
        VERSION=$(grep '^version: ' pubspec.yaml | cut -d ' ' -f 2 | cut -d '+' -f 1)
        echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
        echo "App version: $VERSION"
    
    - name: Upload APK artifacts
      uses: actions/upload-artifact@v4
      with:
        name: apk-release-${{ steps.version.outputs.VERSION }}
        path: |
          build/app/outputs/flutter-apk/app-release.apk
          build/app/outputs/flutter-apk/app-armeabi-v7a-release.apk
          build/app/outputs/flutter-apk/app-arm64-v8a-release.apk
          build/app/outputs/flutter-apk/app-x86_64-release.apk
    
    - name: Create GitHub Release
      if: startsWith(github.ref, 'refs/tags/v')
      uses: softprops/action-gh-release@v1
      with:
        files: |
          build/app/outputs/flutter-apk/app-release.apk
          build/app/outputs/flutter-apk/app-armeabi-v7a-release.apk
          build/app/outputs/flutter-apk/app-arm64-v8a-release.apk
          build/app/outputs/flutter-apk/app-x86_64-release.apk
        name: Release ${{ steps.version.outputs.VERSION }}
        body: |
          ## SayeKatale v${{ steps.version.outputs.VERSION }}
          
          ### What's New
          - See [CHANGELOG.md](CHANGELOG.md) for details
          
          ### Downloads
          - **Universal APK**: Works on all devices (larger file)
          - **ARM64**: For modern Android devices (64-bit)
          - **ARMv7**: For older Android devices (32-bit)
          - **x86_64**: For Intel-based devices
          
          ### Installation
          1. Download the appropriate APK for your device
          2. Enable "Install from Unknown Sources" in Settings
          3. Install the APK
          4. Grant necessary permissions
          
          ### Requirements
          - Android 5.0 (Lollipop) or higher
          - Internet connection
          - Mobile money account (for payments)
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  
  # ========================================
  # Build AAB Job - For Play Store
  # ========================================
  build-aab:
    name: Build App Bundle (AAB)
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/production' || startsWith(github.ref, 'refs/tags/v')
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Java
      uses: actions/setup-java@v4
      with:
        distribution: 'zulu'
        java-version: ${{ env.JAVA_VERSION }}
    
    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: ${{ env.FLUTTER_VERSION }}
        channel: 'stable'
        cache: true
    
    - name: Install dependencies
      run: flutter pub get
    
    - name: Decode Android keystore
      run: |
        echo "${{ secrets.ANDROID_KEYSTORE }}" | base64 -d > android/release-key.jks
        echo "storePassword=${{ secrets.ANDROID_STORE_PASSWORD }}" > android/key.properties
        echo "keyPassword=${{ secrets.ANDROID_KEY_PASSWORD }}" >> android/key.properties
        echo "keyAlias=release" >> android/key.properties
        echo "storeFile=../release-key.jks" >> android/key.properties
    
    - name: Decode google-services.json
      run: |
        echo "${{ secrets.GOOGLE_SERVICES_JSON }}" | base64 -d > android/app/google-services.json
    
    - name: Build App Bundle
      run: |
        flutter build appbundle --release \
          --dart-define=PRODUCTION=true \
          --dart-define=PAWAPAY_API_TOKEN=${{ secrets.PAWAPAY_API_TOKEN }} \
          --dart-define=PAWAPAY_DEPOSIT_CALLBACK=${{ secrets.PAWAPAY_DEPOSIT_CALLBACK }} \
          --dart-define=PAWAPAY_WITHDRAWAL_CALLBACK=${{ secrets.PAWAPAY_WITHDRAWAL_CALLBACK }} \
          --dart-define=API_BASE_URL=${{ secrets.API_BASE_URL }}
    
    - name: Upload AAB artifact
      uses: actions/upload-artifact@v4
      with:
        name: aab-release
        path: build/app/outputs/bundle/release/app-release.aab

  # ========================================
  # Notify Job - Send notifications
  # ========================================
  notify:
    name: Send Notifications
    needs: [build-apk, build-aab]
    runs-on: ubuntu-latest
    if: always() && (github.ref == 'refs/heads/production' || startsWith(github.ref, 'refs/tags/v'))
    
    steps:
    - name: Build Success Notification
      if: needs.build-apk.result == 'success' && needs.build-aab.result == 'success'
      run: |
        echo "✅ Production build completed successfully!"
        echo "APK and AAB files are ready for deployment."
    
    - name: Build Failure Notification
      if: needs.build-apk.result == 'failure' || needs.build-aab.result == 'failure'
      run: |
        echo "❌ Production build failed!"
        echo "Check the logs for details."
        exit 1
