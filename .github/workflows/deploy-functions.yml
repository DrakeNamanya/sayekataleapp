name: Deploy Firebase Functions

on:
  # Trigger on push to main branch when functions code changes
  push:
    branches:
      - main
    paths:
      - 'functions/**'
      - '.github/workflows/deploy-functions.yml'
  
  # Allow manual trigger from GitHub Actions tab
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy to Firebase
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: 'functions/package-lock.json'
      
      - name: Install dependencies
        run: |
          cd functions
          npm ci
      
      - name: Setup Firebase CLI
        run: npm install -g firebase-tools
      
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.FIREBASE_SERVICE_ACCOUNT }}
      
      - name: Deploy to Firebase
        run: |
          # Get project ID from firebase.json or use default
          PROJECT_ID=$(firebase projects:list | grep -oP '(?<=â”‚\s)\S+(?=\s+â”‚)' | head -1)
          
          echo "ðŸš€ Deploying Cloud Functions to project: $PROJECT_ID"
          
          # Deploy functions
          firebase deploy --only functions --force
          
          echo "âœ… Deployment complete!"
          echo ""
          echo "ðŸ“‹ Webhook URL:"
          echo "https://us-central1-${PROJECT_ID}.cloudfunctions.net/pawaPayWebhook"
          echo ""
          echo "ðŸ” Health check:"
          echo "https://us-central1-${PROJECT_ID}.cloudfunctions.net/pawaPayWebhookHealth"
      
      - name: Verify deployment
        run: |
          PROJECT_ID=$(firebase projects:list | grep -oP '(?<=â”‚\s)\S+(?=\s+â”‚)' | head -1)
          HEALTH_URL="https://us-central1-${PROJECT_ID}.cloudfunctions.net/pawaPayWebhookHealth"
          
          echo "ðŸ” Testing health endpoint..."
          sleep 10  # Wait for function to be ready
          
          RESPONSE=$(curl -s $HEALTH_URL || echo "error")
          
          if [[ $RESPONSE == *"healthy"* ]]; then
            echo "âœ… Health check passed!"
            echo "$RESPONSE"
          else
            echo "âš ï¸ Health check returned unexpected response:"
            echo "$RESPONSE"
          fi
      
      - name: Post deployment summary
        run: |
          echo "## ðŸŽ‰ Deployment Successful!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Deployed Functions:" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… pawaPayWebhook (Main webhook handler)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… pawaPayWebhookHealth (Health check)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… manualActivateSubscription (Admin utility)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Next Steps:" >> $GITHUB_STEP_SUMMARY
          echo "1. Copy webhook URL from logs above" >> $GITHUB_STEP_SUMMARY
          echo "2. Configure in PawaPay Dashboard" >> $GITHUB_STEP_SUMMARY
          echo "3. Test with a small payment" >> $GITHUB_STEP_SUMMARY

# Workflow permissions
permissions:
  contents: read
  id-token: write
